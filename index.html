<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Navigation System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        header {
            background: #2c3e50;
            color: white;
            padding: 30px;
            text-align: center;
        }
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: 1.2em;
            opacity: 0.8;
        }
        .content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 0;
            min-height: 700px;
        }
        .controls {
            background: #ecf0f1;
            padding: 25px;
            overflow-y: auto;
            max-height: 700px;
        }
        .map-container {
            background: #34495e;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .control-group {
            margin-bottom: 25px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        h3 {
            color: #34495e;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        select, input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #3498db;
        }
        button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        button.secondary {
            background: #95a5a6;
        }
        button.secondary:hover {
            background: #7f8c8d;
        }
        button.small {
            padding: 8px 12px;
            font-size: 12px;
            width: auto;
        }
        #map-image {
            max-width: 100%;
            max-height: 600px;
            border: 3px solid #ecf0f1;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .results {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .path-step {
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        .path-info {
            flex: 1;
        }
        .room-type {
            font-size: 0.9em;
            color: #7f8c8d;
            font-style: italic;
        }
        .loading {
            color: #7f8c8d;
            text-align: center;
            padding: 20px;
            font-style: italic;
        }
        .error {
            color: #e74c3c;
            background: #fadbd8;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .success {
            color: #27ae60;
            background: #d5f4e6;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        .status.healthy {
            background: #d5f4e6;
            color: #27ae60;
        }
        .status.error {
            background: #fadbd8;
            color: #e74c3c;
        }
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            margin-top: 10px;
        }
        .search-result {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
            cursor: pointer;
            transition: background 0.2s;
        }
        .search-result:hover {
            background: #3498db;
            color: white;
        }
        .room-detail {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        .filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè• Hospital Navigation System</h1>
            <div class="subtitle">Intelligent Room Finding with Attributes</div>
        </header>
        
        <div class="content">
            <div class="controls">
                <div class="control-group">
                    <h2>üè¢ Floor Selection</h2>
                    <select id="floor-select">
                        <option value="1">Level 1 (Ground Floor)</option>
                        <option value="2">Level 2</option>
                        <option value="3">Level 3</option>
                    </select>
                    <button onclick="loadMap()">üìä Load Floor Map</button>
                    <button onclick="loadRoomTypes()" class="secondary">üìã View Room Types</button>
                </div>

                <div class="control-group">
                    <h2>üîç Room Search</h2>
                    <input type="text" id="search-query" placeholder="Search by room number or type...">
                    <div class="filters">
                        <select id="room-type-filter">
                            <option value="">All Room Types</option>
                        </select>
                        <select id="level-filter">
                            <option value="">All Floors</option>
                        </select>
                    </div>
                    <button onclick="searchRooms()">üîé Search Rooms</button>
                    <div id="search-results" class="search-results" style="display: none;"></div>
                </div>

                <div class="control-group">
                    <h2>üß≠ Navigation</h2>
                    <h3>Start Room</h3>
                    <input type="text" id="start-room" placeholder="Enter room number (e.g., A10, ME1)">
                    
                    <h3>Destination Room</h3>
                    <input type="text" id="dest-room" placeholder="Enter room number (e.g., C22, E30)">
                    
                    <button onclick="findPath()">üöÄ Find Shortest Path</button>
                    <button onclick="suggestRooms()" class="secondary">üí° Suggest Popular Routes</button>
                </div>

                <div class="control-group">
                    <h2>üìä System Status</h2>
                    <div id="system-status" class="status">Click to check status</div>
                    <button onclick="checkHealth()">üîÑ Check System Status</button>
                </div>
            </div>

            <div class="map-container">
                <div id="map-content">
                    <p class="loading">Select a floor and click 'Load Floor Map' to begin</p>
                    <img id="map-image" style="display: none;" alt="Hospital Map">
                </div>
            </div>
        </div>

        <div class="results" id="results-container">
            <!-- Results will appear here -->
        </div>
    </div>

    <script>
        let currentLevel = '1';
        let roomTypes = [];
        let allFloors = [];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkHealth();
            loadRoomTypes();
            loadFloors();
        });

        async function loadMap() {
            const mapContent = document.getElementById('map-content');
            const img = document.getElementById('map-image');
            currentLevel = document.getElementById('floor-select').value;
            
            mapContent.innerHTML = '<p class="loading">Loading floor map... Please wait</p>';
            
            try {
                const timestamp = new Date().getTime();
                img.src = `/graph-image/${currentLevel}?t=${timestamp}`;
                img.style.display = 'block';
                
                img.onload = function() {
                    mapContent.innerHTML = '';
                    mapContent.appendChild(img);
                    showMessage('success', `Floor ${currentLevel} map loaded successfully`);
                };
                
                img.onerror = function() {
                    mapContent.innerHTML = '<p class="error">Error loading floor map</p>';
                };
                
            } catch (error) {
                showMessage('error', 'Error loading map: ' + error.message);
            }
        }

        async function loadRoomTypes() {
            try {
                const response = await fetch('/api/room-types');
                const data = await response.json();
                roomTypes = data.room_types;
                
                const select = document.getElementById('room-type-filter');
                select.innerHTML = '<option value="">All Room Types</option>';
                
                roomTypes.forEach(type => {
                    if (type && type !== 'NULL') {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        select.appendChild(option);
                    }
                });
            } catch (error) {
                console.error('Error loading room types:', error);
            }
        }

        async function loadFloors() {
            try {
                const response = await fetch('/api/floors');
                const data = await response.json();
                allFloors = data.floors;
                
                const select = document.getElementById('level-filter');
                select.innerHTML = '<option value="">All Floors</option>';
                
                allFloors.forEach(floor => {
                    const option = document.createElement('option');
                    option.value = floor.level;
                    option.textContent = `Level ${floor.level}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading floors:', error);
            }
        }

        async function searchRooms() {
            const query = document.getElementById('search-query').value.trim();
            const roomType = document.getElementById('room-type-filter').value;
            const level = document.getElementById('level-filter').value;
            const resultsDiv = document.getElementById('search-results');
            
            if (!query && !roomType && !level) {
                showMessage('error', 'Please enter search criteria or select filters');
                return;
            }

            try {
                let url = `/api/search-rooms?q=${encodeURIComponent(query)}`;
                if (roomType) url += `&type=${encodeURIComponent(roomType)}`;
                if (level) url += `&level=${encodeURIComponent(level)}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.results.length > 0) {
                    let html = '';
                    data.results.forEach(room => {
                        html += `<div class="search-result" onclick="selectRoom('${room.room_no}', '${room.room_type}', '${room.level}')">
                               <strong>${room.room_no || 'No Number'}</strong> - ${room.room_type}
                               <div class="room-detail">Level ${room.level} ‚Ä¢ Node: ${room.node_id}</div>
                               </div>`;
                    });
                    resultsDiv.innerHTML = html;
                    resultsDiv.style.display = 'block';
                } else {
                    resultsDiv.innerHTML = '<div class="search-result">No rooms found</div>';
                    resultsDiv.style.display = 'block';
                }
            } catch (error) {
                showMessage('error', 'Search error: ' + error.message);
            }
        }

        function selectRoom(roomNo, roomType, level) {
            // Auto-fill the start or destination room
            if (!document.getElementById('start-room').value) {
                document.getElementById('start-room').value = roomNo;
                document.getElementById('floor-select').value = level;
                showMessage('success', `Selected ${roomNo} (${roomType}) as start room`);
            } else {
                document.getElementById('dest-room').value = roomNo;
                showMessage('success', `Selected ${roomNo} (${roomType}) as destination`);
            }
            document.getElementById('search-results').style.display = 'none';
        }

        async function findPath() {
            const start = document.getElementById('start-room').value.trim();
            const dest = document.getElementById('dest-room').value.trim();
            const resultsDiv = document.getElementById('results-container');

            if (!start || !dest) {
                showMessage('error', 'Please enter both start and destination rooms');
                return;
            }

            resultsDiv.innerHTML = '<p class="loading">Finding shortest path... üß≠</p>';

            try {
                const response = await fetch('/shortest-path', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        start: start,
                        end: dest,
                        level: currentLevel
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    let html = `<div class="success">
                               <h3>‚úÖ Path Found! (${data.distance} steps from ${data.start_room} to ${data.end_room})</h3>`;
                    
                    data.formatted_path.forEach((room, index) => {
                        html += `<div class="path-step">
                               <div class="path-info">
                                   <strong>Step ${index + 1}:</strong> 
                                   ${room.room_no ? `<strong>${room.room_no}</strong>` : 'No Number'} 
                                   - ${room.room_type}
                                   <div class="room-detail">Level ${room.level}</div>
                               </div>
                               </div>`;
                    });
                    
                    html += `<p><strong>Total distance:</strong> ${data.distance} locations to pass through</p>`;
                    html += '</div>';
                    
                    resultsDiv.innerHTML = html;
                } else {
                    showMessage('error', `Pathfinding error: ${data.error}`);
                }
            } catch (error) {
                showMessage('error', 'Network error: ' + error.message);
            }
        }

        async function suggestRooms() {
            // Suggest popular room combinations based on room types
            const suggestions = [
                { start: 'ME1', dest: 'A10', desc: 'Main Elevators to Admitting' },
                { start: 'A10', dest: 'A12', desc: 'Admitting to Pharmacy' },
                { start: 'C11', dest: 'B10', desc: 'Emergency Care to Emergency' },
                { start: 'ME1', dest: 'C22', desc: 'Main Elevators to Newborn ICU' }
            ];
            
            let html = '<div class="success"><h3>üí° Popular Route Suggestions:</h3>';
            suggestions.forEach(suggestion => {
                html += `<div class="path-step">
                       <strong>${suggestion.start} ‚Üí ${suggestion.dest}</strong>: ${suggestion.desc}
                       <button class="small" onclick="setRoute('${suggestion.start}', '${suggestion.dest}')">Use This Route</button>
                       </div>`;
            });
            html += '</div>';
            
            document.getElementById('results-container').innerHTML = html;
        }

        function setRoute(start, dest) {
            document.getElementById('start-room').value = start;
            document.getElementById('dest-room').value = dest;
            showMessage('success', `Route set: ${start} ‚Üí ${dest}`);
        }

        async function checkHealth() {
            const statusDiv = document.getElementById('system-status');
            
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    statusDiv.innerHTML = `‚úÖ System Healthy - ${data.total_rooms} rooms, ${data.room_types_count} types, ${data.floors_loaded.length} floors`;
                    statusDiv.className = 'status healthy';
                } else {
                    statusDiv.innerHTML = '‚ùå System Error - Graph not loaded';
                    statusDiv.className = 'status error';
                }
            } catch (error) {
                statusDiv.innerHTML = '‚ùå Cannot connect to server';
                statusDiv.className = 'status error';
            }
        }

        function showMessage(type, message) {
            const resultsDiv = document.getElementById('results-container');
            resultsDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        // Add keyboard shortcuts
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (document.getElementById('search-query').value) {
                    searchRooms();
                } else {
                    findPath();
                }
            }
        });
    </script>
</body>
</html>